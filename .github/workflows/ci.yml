name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.5'

    - name: Build
      run: go build -v ./cmd/bw

    - name: Test
      run: go test -covermode=atomic -coverprofile=coverage.out ./pkg/... ./cmd/bw

    - name: E2E Tests
      run: go test -v ./tests/e2e -count=1

    - name: Enforce Coverage Threshold
      run: |
        total=$(awk '
          NR == 1 { next }
          {
            file = $1
            sub(/:.*/, "", file)
            if (file !~ /^github.com\/vanderheijden86\/beadwork\/pkg\//) next
            stmts = $2; count = $3; all += stmts
            if (count > 0) hit += stmts
          }
          END {
            if (all == 0) { printf("0.00"); exit 0 }
            printf("%.2f", (hit / all) * 100)
          }
        ' coverage.out)
        echo "pkg/* coverage: ${total}% (threshold 71%)"
        awk -v c="$total" 'BEGIN { if (c < 71.0) { printf("FAIL: pkg/* coverage %.2f%% is below 71%%\n", c); exit 1 } }'
